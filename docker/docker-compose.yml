# Docker Compose for S3 ACID Database
# Stack: Apache Iceberg + DuckDB + S3 (MinIO locally) + REST Catalog
# Future: Deploy to AWS Lambda with Glue Catalog

services:
  # MinIO - S3-compatible storage for local development
  minio:
    image: minio/minio:latest
    container_name: s3-acid-minio
    ports:
      - "9005:9000"      # MinIO API (S3-compatible)
      - "9006:9001"      # MinIO Console (http://localhost:9006)
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - acid-network

  # Initialize MinIO buckets
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/test-bucket --ignore-existing;
      mc mb myminio/iceberg-warehouse --ignore-existing;
      mc policy set public myminio/test-bucket;
      mc policy set public myminio/iceberg-warehouse;
      echo 'MinIO buckets created successfully';
      "
    networks:
      - acid-network

  # PyIceberg REST Catalog Server
  iceberg-rest:
    image: tabulario/iceberg-rest:0.10.0
    container_name: s3-acid-iceberg-rest
    ports:
      - "8181:8181"
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: us-east-1
      CATALOG_WAREHOUSE: s3://iceberg-warehouse/
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO
      CATALOG_S3_ENDPOINT: http://minio:9000
      CATALOG_S3_PATH__STYLE__ACCESS: true
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - acid-network

  # AWS Lambda container running our API
  # Uses DuckDB for queries, Iceberg for table format, S3 for storage
  lambda-api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: s3-acid-lambda
    ports:
      - "8080:8080"  # Lambda Runtime Interface Emulator
    environment:
      # Environment selector - determines which config.json section to use
      ENVIRONMENT: development

      # Lambda Runtime Configuration
      AWS_LAMBDA_FUNCTION_TIMEOUT: 900
      AWS_LAMBDA_FUNCTION_MEMORY_SIZE: 3008

      # Note: All other configuration (S3, Catalog, DuckDB, Performance)
      # is loaded from config.json based on ENVIRONMENT value.
      # For production, set ENVIRONMENT=production and provide:
      # - BUCKET_NAME
      # - AWS_REGION
      # - AWS_ACCOUNT_ID
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      iceberg-rest:
        condition: service_started
    volumes:
      - ../src:/var/task/src:ro
      - ../config:/var/task/config:ro
    networks:
      - acid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/2015-03-31/functions/function/invocations", "-X", "POST", "-d", '{"httpMethod":"GET","path":"/health"}']
      interval: 10s
      timeout: 5s
      retries: 3

  # FastAPI Server - Alternative entry point for reliable local testing
  # Uses the same operations code as Lambda, but with FastAPI instead of Lambda emulator
  fastapi:
    build:
      context: ..
      dockerfile: docker/Dockerfile.fastapi
    container_name: s3-acid-fastapi
    ports:
      - "9000:8000"  # FastAPI server
    environment:
      ENVIRONMENT: development
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      iceberg-rest:
        condition: service_started
    volumes:
      - ../src:/app/src:ro
      - ../config/config.json:/app/config/config.json:ro
      - ../fastapi_app.py:/app/fastapi_app.py:ro
      - ../docs:/app/docs:ro
    command: ["python", "fastapi_app.py"]
    networks:
      - acid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  acid-network:
    driver: bridge

volumes:
  minio_data:
    driver: local
